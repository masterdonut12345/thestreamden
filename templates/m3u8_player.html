<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stream Player</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        background: #000;
        height: 100%;
      }
      .player-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }
      .player-stack {
        position: relative;
        width: 100%;
        height: 100%;
      }
      video {
        width: 100%;
        height: 100%;
        background: #000;
      }
      .fallback {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 24px;
        text-align: center;
      }
      .fallback a {
        color: #7aa7ff;
      }
    </style>
  </head>
  <body>
    <div class="player-wrap">
      {% if src %}
        <div class="player-stack">
          <video id="hls-video" controls autoplay playsinline crossorigin="anonymous">
            <source src="{{ proxy_src or src }}" type="application/vnd.apple.mpegurl">
            <source src="{{ proxy_src or src }}" type="application/x-mpegURL">
          </video>
          <div class="fallback" id="hls-fallback" hidden>
            <strong>Stream unavailable.</strong>
            <div>Try opening the stream directly: <a href="{{ src }}" target="_blank" rel="noopener">Open m3u8</a></div>
          </div>
        </div>
      {% else %}
        <div class="fallback">
          <strong>Stream unavailable.</strong>
        </div>
      {% endif %}
    </div>

    {% if src %}
      <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
      <script>
        (function () {
          const src = "{{ proxy_src|e }}";
          const video = document.getElementById("hls-video");
          const fallback = document.getElementById("hls-fallback");
          if (!video || !src) return;

          function showFallback() {
            if (fallback) {
              fallback.hidden = false;
            }
          }

          function hideFallback() {
            if (fallback) {
              fallback.hidden = true;
            }
          }

          if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = src;
            return;
          }

          function attemptPlay() {
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === "function") {
              playPromise.catch(function () {
                // Autoplay can be blocked; user can start manually.
              });
            }
          }

          if (window.Hls && window.Hls.isSupported()) {
            const hls = new window.Hls({
              capLevelToPlayerSize: true,
              maxBufferLength: 30,
            });
            hls.on(window.Hls.Events.ERROR, function (_, data) {
              if (data && data.fatal) {
                showFallback();
              }
            });
            hls.on(window.Hls.Events.MANIFEST_PARSED, function () {
              attemptPlay();
            });
            hls.loadSource(src);
            hls.attachMedia(video);
            return;
          }

          video.src = src;
          video.addEventListener("error", showFallback, { once: true });
          video.addEventListener("loadedmetadata", attemptPlay, { once: true });
          video.addEventListener("playing", hideFallback);
          video.addEventListener("play", hideFallback);
        })();
      </script>
    {% endif %}
  </body>
</html>
