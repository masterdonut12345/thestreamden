<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stream Player</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        background: #000;
        height: 100%;
      }
      .player-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }
      .player-stack {
        position: relative;
        width: 100%;
        height: 100%;
      }
      video {
        width: 100%;
        height: 100%;
        background: #000;
      }
      .fallback {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 24px;
        text-align: center;
      }
      .fallback a {
        color: #7aa7ff;
      }
    </style>
  </head>
  <body>
    <div class="player-wrap">
      {% if src %}
        <div class="player-stack">
          <video id="hls-video" controls autoplay playsinline crossorigin="anonymous">
            <source src="{{ proxy_src or src }}" type="application/vnd.apple.mpegurl">
            <source src="{{ proxy_src or src }}" type="application/x-mpegURL">
          </video>
        </div>
      {% else %}
        <div class="fallback">
          <strong>Stream unavailable.</strong>
        </div>
      {% endif %}
    </div>

    {% if src %}
      <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
      <script>
        (function () {
          const src = "{{ proxy_src|e }}";
          const video = document.getElementById("hls-video");
          if (!video || !src) return;
          const minReloadGapMs = 15000;
          const stallCheckIntervalMs = 5000;
          const stallThresholdMs = 20000;
          let hls = null;
          let lastReloadTs = 0;
          let lastProgressTs = Date.now();

          function withCacheBust(url) {
            if (!url) return url;
            const sep = url.includes("?") ? "&" : "?";
            return `${url}${sep}reload=${Date.now()}`;
          }

          const canUseNative = video.canPlayType("application/vnd.apple.mpegurl");
          const shouldUseHls = window.Hls && window.Hls.isSupported();
          if (canUseNative && !shouldUseHls) {
            video.src = src;
          }

          function attemptPlay() {
            const playPromise = video.play();
            if (playPromise && typeof playPromise.catch === "function") {
              playPromise.catch(function () {
                // Autoplay can be blocked; user can start manually.
              });
            }
          }

          function reloadStream(reason) {
            const now = Date.now();
            if (now - lastReloadTs < minReloadGapMs) {
              return;
            }
            lastReloadTs = now;
            const newSrc = withCacheBust(src);
            console.warn("Reloading HLS stream", reason || "");
            const resumeTime = video.currentTime;
            const restorePosition = function () {
              if (!Number.isFinite(resumeTime)) {
                return;
              }
              if (video.seekable && video.seekable.length > 0) {
                const maxSeek = video.seekable.end(video.seekable.length - 1);
                if (resumeTime <= maxSeek) {
                  video.currentTime = resumeTime;
                }
              }
            };
            if (hls) {
              hls.stopLoad();
              hls.detachMedia();
              hls.loadSource(newSrc);
              hls.attachMedia(video);
              hls.startLoad();
              video.addEventListener("loadedmetadata", restorePosition, { once: true });
              attemptPlay();
              return;
            }
            video.src = newSrc;
            video.load();
            video.addEventListener("loadedmetadata", restorePosition, { once: true });
            attemptPlay();
          }

          function markProgress() {
            lastProgressTs = Date.now();
          }

          function startStallMonitor() {
            setInterval(function () {
              if (video.paused || video.ended || video.seeking) {
                return;
              }
              if (Date.now() - lastProgressTs > stallThresholdMs) {
                reloadStream("stall-timeout");
                lastProgressTs = Date.now();
              }
            }, stallCheckIntervalMs);
          }

          if (shouldUseHls) {
            hls = new window.Hls({
              enableWorker: true,
              capLevelToPlayerSize: true,
              maxBufferLength: 90,
              backBufferLength: 30,
              maxBufferSize: 50 * 1000 * 1000,
              liveSyncDurationCount: 4,
              liveMaxLatencyDurationCount: 8,
              lowLatencyMode: false,
            });
            hls.on(window.Hls.Events.ERROR, function (_, data) {
              if (data && data.fatal) {
                console.warn("Fatal HLS error", data);
                if (data.type === window.Hls.ErrorTypes.NETWORK_ERROR) {
                  hls.startLoad();
                  reloadStream("network-error");
                  return;
                }
                if (data.type === window.Hls.ErrorTypes.MEDIA_ERROR) {
                  hls.recoverMediaError();
                  return;
                }
                hls.destroy();
                hls = null;
                if (canUseNative) {
                  video.src = src;
                  attemptPlay();
                  return;
                }
                reloadStream("fatal-error");
              }
            });
            hls.on(window.Hls.Events.MANIFEST_PARSED, function () {
              attemptPlay();
            });
            hls.loadSource(src);
            hls.attachMedia(video);
            video.addEventListener("timeupdate", markProgress);
            video.addEventListener("playing", markProgress);
            video.addEventListener("loadedmetadata", markProgress);
            startStallMonitor();
            return;
          }

          if (!canUseNative) {
            video.src = src;
          }
          video.addEventListener("loadedmetadata", attemptPlay, { once: true });
          video.addEventListener("timeupdate", markProgress);
          video.addEventListener("playing", markProgress);
          startStallMonitor();
        })();
      </script>
    {% endif %}
  </body>
</html>
