<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Stream Den</title>

    <style>
      :root {
        --ink: #1b2432;
        --muted: #4f5b73;
        --paper: #f2f4fb;
        --panel: #ffffff;
        --panel-soft: #f8f9fc;
        --border: #c8d0dd;
        --stripe: #e6ebf5;
        --accent: #2f4f9c;
        --accent-strong: #1f3d80;
        --highlight: #f5f7ff;
      }

      * { box-sizing: border-box; }

      body {
        font-family: "Georgia", "Times New Roman", serif;
        color: var(--ink);
        background: var(--paper);
        padding: 26px 16px 40px;
        margin: 0;
      }

      a { color: var(--accent); }
      a:visited { color: var(--accent-strong); }

      .forum-shell {
        max-width: 1080px;
        margin: 0 auto;
        background: var(--panel);
        border: 1px solid var(--border);
        box-shadow: 0 12px 30px rgba(26, 44, 92, 0.18);
      }

      .forum-banner {
        padding: 18px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, #3c5586, #2d416f);
        color: #f4f6ff;
      }

      .forum-banner h1 { margin: 0 0 4px 0; font-size: 26px; letter-spacing: -0.01em; }
      .tagline { margin: 0; font-size: 13px; color: #d8e1f7; }

      .nav-actions { display: flex; gap: 10px; align-items: center; }
      .nav-btn {
        display: inline-block;
        padding: 8px 12px;
        font-size: 13px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        color: #f5f7ff;
        text-decoration: none;
        background: linear-gradient(180deg, #4a66a6, #2f4677);
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }
      .nav-btn:hover { background: linear-gradient(180deg, #5875b6, #375084); }

      .crumbs {
        padding: 11px 16px 10px 16px;
        font-size: 12px;
        border-bottom: 1px solid var(--border);
        background: #eef2fa;
      }
      .crumbs a { text-decoration: none; font-weight: 600; }
      .crumbs .sep { padding: 0 6px; color: var(--muted); }

      .board-card + .board-card { border-top: 1px solid var(--border); }
      .board-head {
        padding: 14px 16px 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: linear-gradient(180deg, #f5f7ff, #eef2fa);
      }
      .board-title { font-size: 18px; font-weight: 700; letter-spacing: -0.01em; }
      .board-subtext { margin-top: 4px; font-size: 13px; color: var(--muted); }
      .board-actions { display: flex; align-items: center; gap: 8px; }

      .chip {
        display: inline-block;
        padding: 5px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        background: var(--panel-soft);
      }

      .ghost-btn {
        font-family: inherit;
        font-size: 13px;
        padding: 7px 11px;
        border: 1px solid var(--border);
        background: #f5f7ff;
        color: var(--ink);
        cursor: pointer;
        border-radius: 3px;
      }
      .ghost-btn:hover { background: var(--highlight); }

      .board-body { padding: 14px 16px 18px 16px; background: #ffffff; }
      .form-body { background: var(--panel-soft); border-top: 1px solid var(--border); }

      .forum-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .forum-table th, .forum-table td {
        border: 1px solid var(--border);
        padding: 10px;
        background: #fff;
      }
      .forum-table th {
        background: linear-gradient(180deg, #f6f8ff, #ecf0f8);
        text-align: left;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--muted);
      }
      .forum-table tr:nth-child(even) td { background: var(--panel-soft); }

      .cat-name { font-size: 15px; font-weight: 700; color: var(--accent-strong); }
      .cat-desc { font-size: 12px; margin-top: 4px; color: var(--muted); }

      .thread-title { font-weight: 700; font-size: 14px; color: var(--accent-strong); }
      .thread-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
      .mono { font-family: "SFMono-Regular", "Consolas", monospace; font-size: 12px; color: #45516a; }

      .col-count { width: 90px; text-align: center; }
      .col-action { width: 120px; text-align: center; }
      .col-time { width: 210px; text-align: center; }

      .link-btn {
        display: inline-block;
        padding: 7px 10px;
        background: #f0f3fb;
        border: 1px solid var(--border);
        color: var(--accent-strong);
        text-decoration: none;
        font-weight: 700;
        font-size: 12px;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px #ffffffb0;
      }
      .link-btn:hover { background: #e5ebf7; }

      .bucket { margin-bottom: 14px; border: 1px solid var(--border); background: #ffffff; }
      .bucket-head {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(180deg, #f3f6ff, #e9eef7);
        border-bottom: 1px solid var(--border);
      }
      .bucket-name { font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; font-size: 12px; color: var(--muted); }

      .empty-row {
        padding: 12px;
        border: 1px dashed var(--border);
        background: var(--panel-soft);
        font-size: 13px;
        color: var(--muted);
      }

      .forum-form label { font-weight: 700; font-size: 13px; color: var(--ink); }
      .forum-form input[type="text"],
      .forum-form textarea,
      .forum-form select {
        width: 100%;
        max-width: 520px;
        padding: 8px;
        border: 1px solid var(--border);
        font-size: 13px;
        background: #fff;
        color: var(--ink);
        border-radius: 3px;
      }
      .forum-form textarea { resize: vertical; min-height: 110px; }
      .forum-form .form-row { margin-top: 12px; }
      .forum-form input[type="submit"] {
        margin-top: 6px;
        padding: 8px 14px;
        font-size: 13px;
        border: 1px solid var(--border);
        background: #f0f3fb;
        color: var(--accent-strong);
        cursor: pointer;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px #ffffffb0;
      }
      .forum-form input[type="submit"]:hover { background: #e5ebf7; }

      .form-actions { margin-bottom: 10px; }
      .hint { font-size: 11px; color: var(--muted); margin-left: 6px; }

      .tip-line { font-size: 12px; margin-top: 6px; color: var(--muted); }
    </style>

    <script>
      function toggleBox(listId, formId, btnId, mode) {
        var list = document.getElementById(listId);
        var form = document.getElementById(formId);
        var btn = document.getElementById(btnId);
        if (mode === "form") {
          if (list) list.style.display = "none";
          if (form) form.style.display = "block";
          if (btn) btn.style.display = "none";
        } else {
          if (form) form.style.display = "none";
          if (list) list.style.display = "block";
          if (btn) btn.style.display = "inline-block";
        }
      }

      function openForm(e, containerId, listId, formId, btnId) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var box = document.getElementById(containerId);
        if (box) box.classList.add("expanded");
        toggleBox(listId, formId, btnId, "form");
      }

      // auto-open add-thread form when redirected back from choose_stream
      function autoOpenThreadForm() {
        var shouldOpen = "{{ '1' if open_thread_form else '0' }}";
        if (shouldOpen === "1") {
          openForm(null, "threads-box", "thread-list", "thread-form", "add-thread-btn");
        }
      }

      window.addEventListener("DOMContentLoaded", autoOpenThreadForm);
    </script>
  </head>

  <body>
    <div class="forum-shell">
      <div class="forum-banner">
        <div>
          <h1>The Stream Den</h1>
          <p class="tagline">Share streams and links in a clean, classic forum layout.</p>
        </div>
        <div class="nav-actions">
          {% if parent_path %}
            <a class="nav-btn" href="/forum/{{ parent_path }}">← Back</a>
          {% else %}
            <a class="nav-btn" href="/forum">← Forum home</a>
          {% endif %}
        </div>
      </div>

      <div class="crumbs">
        {% for crumb in breadcrumbs %}
          {% if not loop.first %}<span class="sep">&raquo;</span>{% endif %}
          <a href="{{ crumb.url }}">{{ crumb.name }}</a>
        {% endfor %}
      </div>

      <!-- Subcategories -->
      <section id="subcategories-box" class="board-card">
        <div class="board-head">
          <div>
            <div class="board-title">Subcategories</div>
            <div class="board-subtext">Pick a room to browse threads.</div>
          </div>
          <div class="board-actions">
            <span class="chip">{{ categories|length }} total</span>
            <button id="add-cat-btn" class="ghost-btn" type="button"
                    onclick="openForm(event,'subcategories-box','subcat-list','subcat-form','add-cat-btn')">+ New category</button>
          </div>
        </div>

        <div id="subcat-list" class="board-body">
          {% if categories|length == 0 %}
            <div class="empty-row">No rooms yet. Start the first category.</div>
          {% else %}
            <table class="forum-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="col-count">Threads</th>
                  <th class="col-action">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in categories %}
                  <tr>
                    <td>
                      <div class="cat-name">{{ cat.name }}</div>
                      <div class="cat-desc">{{ cat.desc }}</div>
                    </td>
                    <td class="col-count">{{ cat.count }}</td>
                    <td class="col-action">
                      <a class="link-btn" href="/forum{% if current_path %}/{{ current_path }}{% endif %}/{{ cat.slug }}">Enter »</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>

        <div id="subcat-form" class="board-body form-body" style="display:none;">
          <div class="form-actions">
            <button class="ghost-btn" type="button"
                    onclick="toggleBox('subcat-list','subcat-form','add-cat-btn','list');">
              « Back to categories
            </button>
          </div>

          <form action="/add_category" method="POST" class="forum-form">
            <input type="hidden" name="parent_path" value="{{ current_path }}">

            <div class="form-row">
              <label for="category-name">Name</label><br>
              <input type="text" id="category-name" name="category-name" maxlength="12" required>
            </div>

            <div class="form-row">
              <label for="category-desc">Description</label><br>
              <textarea id="category-desc" name="category-desc" rows="4" required></textarea>
            </div>

            <div class="form-row">
              <input type="submit" value="Post category">
            </div>
          </form>
        </div>
      </section>

      <!-- Threads -->
      <section id="threads-box" class="board-card">
        <div class="board-head">
          <div>
            <div class="board-title">Streams &amp; Threads</div>
            <div class="board-subtext">Expiration buckets like a vintage forum lineup.</div>
          </div>

          <div class="board-actions">
            {% if current_path %}
              <button id="add-thread-btn" class="ghost-btn" type="button"
                      onclick="openForm(event,'threads-box','thread-list','thread-form','add-thread-btn')">+ Post a stream</button>
            {% else %}
              <span class="chip">Pick a category to post</span>
            {% endif %}
          </div>
        </div>

        <div id="thread-list" class="board-body">
          {% if not current_path %}
            <div class="empty-row">Choose a subcategory to see and post threads.</div>
          {% else %}
            {% for bucket in exp_choices %}
              <div class="bucket">
                <div class="bucket-head">
                  <div class="bucket-name">Expires: {{ bucket }}</div>
                  <span class="chip">{{ threads_grouped[bucket]|length }} listed</span>
                </div>

                {% if threads_grouped[bucket]|length == 0 %}
                  <div class="empty-row">No streams in this window.</div>
                {% else %}
                  <table class="forum-table thread-table">
                    <thead>
                      <tr>
                        <th>Stream Thread</th>
                        <th class="col-time">Added (UTC)</th>
                        <th class="col-count">Replies</th>
                        <th class="col-action">Link</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for t in threads_grouped[bucket] %}
                        <tr>
                          <td>
                            <div class="thread-title">{{ t.title }}</div>
                            <div class="thread-meta">Expires in {{ bucket }}</div>
                          </td>
                          <td class="col-time"><span class="mono">{{ t.created_at }}</span></td>
                          <td class="col-count">{{ t.reply_count }}</td>
                          <td class="col-action">
                            <a class="link-btn" href="/thread/{{ t.id }}">Open</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <div id="thread-form" class="board-body form-body" style="display:none;">
          <div class="form-actions">
            <button class="ghost-btn" type="button"
                    onclick="toggleBox('thread-list','thread-form','add-thread-btn','list');">
              « Back to threads
            </button>
          </div>

          <form action="/add_thread" method="POST" class="forum-form">
            <input type="hidden" name="category_path" value="{{ current_path }}">

            <div class="form-row">
              <label for="thread-title">Stream title</label><br>
              <input type="text" id="thread-title" name="thread-title" maxlength="80" required>
            </div>

            <div class="form-row">
              <label for="thread-stream-link">Stream link</label>
              <span class="hint">Prefer “embed stream” to auto-fill.</span><br>

              <input type="text" id="thread-stream-link" name="thread-stream-link"
                     value="{{ prefill_stream }}" maxlength="500" required>

              <div class="tip-line">
                <a class="link-btn" href="/embed_stream?return_to=/forum/{{ current_path }}&category_path={{ current_path }}">Embed stream</a>
              </div>
            </div>

            <div class="form-row">
              <label for="thread-expiration">Expiration</label><br>
              <select id="thread-expiration" name="thread-expiration" required>
                {% for opt in exp_choices %}
                  <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-row">
              <input type="submit" value="Post stream">
            </div>
          </form>
        </div>
      </section>
    </div>
  </body>
</html>
