<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Stream Den</title>

    <style>
      :root {
        --ink: #1b2432;
        --muted: #4f5b73;
        --paper: #f2f4fb;
        --panel: #ffffff;
        --panel-soft: #f8f9fc;
        --border: #c8d0dd;
        --stripe: #e6ebf5;
        --accent: #2f4f9c;
        --accent-strong: #1f3d80;
        --highlight: #f5f7ff;
      }

      * { box-sizing: border-box; }

      body {
        font-family: "Georgia", "Times New Roman", serif;
        color: var(--ink);
        background: var(--paper);
        padding: 26px 16px 40px;
        margin: 0;
      }

      a { color: var(--accent); }
      a:visited { color: var(--accent-strong); }

      .forum-shell {
        max-width: 1080px;
        margin: 0 auto;
        background: var(--panel);
        border: 1px solid var(--border);
        box-shadow: 0 12px 30px rgba(26, 44, 92, 0.18);
      }

      .page-wrap {
        max-width: 1440px;
        margin: 0 auto;
        padding: 0 16px 24px 16px;
      }
      .page { display: grid; grid-template-columns: 320px 1fr 260px; gap: 18px; align-items: flex-start; }
      .sidebar { width: 100%; }
      .auth-panel { width: 100%; }
      .main-wrap { min-width: 0; }
      .panel {
        border: 1px solid var(--border);
        background: #fff;
        padding: 12px;
        box-shadow: 0 6px 18px rgba(18, 31, 59, 0.08);
      }
      .panel h3 {
        margin: 0 0 8px 0;
        font-size: 15px;
      }
      .search-panel {
        background: linear-gradient(180deg, #f7f9ff, #eef3ff);
        border: 1px solid #c8d0dd;
        box-shadow: inset 0 0 0 1px #ffffffcc, 0 8px 18px rgba(26, 44, 92, 0.12);
      }
      .search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #c8d0dd;
        border-radius: 4px;
        font-size: 13px;
        background: linear-gradient(180deg, #ffffff, #f4f7ff);
      }
      .search-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .search-btn, .search-clear {
        flex: 1;
        text-align: center;
        padding: 8px;
        border: 1px solid #c8d0dd;
        background: linear-gradient(180deg, #f0f4fb, #e6ecf9);
        color: #1f3d80;
        font-size: 13px;
        cursor: pointer;
        border-radius: 4px;
        text-decoration: none;
        display: inline-block;
      }
      .search-clear { background: linear-gradient(180deg, #f9fbff, #edf2ff); }
      .search-btn:hover, .search-clear:hover { background: linear-gradient(180deg, #e9efff, #dfe7ff); }
      .search-meta { font-size: 12px; color: var(--muted); }

      .auth-panel .search-input { padding: 8px; }
      .auth-panel .search-btn, .auth-panel .search-clear { padding: 6px 10px; }

      .forum-banner {
        padding: 18px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, #3c5586, #2d416f);
        color: #f4f6ff;
      }

      .forum-banner h1 { margin: 0 0 4px 0; font-size: 26px; letter-spacing: -0.01em; }
      .tagline { margin: 0; font-size: 13px; color: #d8e1f7; }

      .nav-actions { display: flex; gap: 10px; align-items: center; }
      .nav-btn {
        display: inline-block;
        padding: 8px 12px;
        font-size: 13px;
        border: 1px solid #1d2740;
        color: #111827;
        text-decoration: none;
        background: linear-gradient(180deg, #ffffff, #f2f4fb);
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.45), 0 2px 6px rgba(0,0,0,0.15);
      }
      .nav-btn:hover { background: linear-gradient(180deg, #f7f9ff, #e7ecf6); }

      .crumbs {
        padding: 11px 16px 10px 16px;
        font-size: 12px;
        border-bottom: 1px solid var(--border);
        background: #eef2fa;
      }
      .crumbs a { text-decoration: none; font-weight: 600; }
      .crumbs .sep { padding: 0 6px; color: var(--muted); }

      .board-card + .board-card { border-top: 1px solid var(--border); }
      .board-head {
        padding: 14px 16px 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: linear-gradient(180deg, #f5f7ff, #eef2fa);
      }
      .board-title { font-size: 18px; font-weight: 700; letter-spacing: -0.01em; }
      .board-subtext { margin-top: 4px; font-size: 13px; color: var(--muted); }
      .board-actions { display: flex; align-items: center; gap: 8px; }

      .chip {
        display: inline-block;
        padding: 5px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        background: var(--panel-soft);
      }

      .ghost-btn {
        font-family: inherit;
        font-size: 13px;
        padding: 7px 11px;
        border: 1px solid var(--border);
        background: #f5f7ff;
        color: var(--ink);
        cursor: pointer;
        border-radius: 3px;
      }
      .ghost-btn:hover { background: var(--highlight); }

      .board-body { padding: 14px 16px 18px 16px; background: #ffffff; }
      .form-body { background: var(--panel-soft); border-top: 1px solid var(--border); }

      .forum-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .forum-table th, .forum-table td {
        border: 1px solid var(--border);
        padding: 10px;
        background: #fff;
      }
      .forum-table th {
        background: linear-gradient(180deg, #f6f8ff, #ecf0f8);
        text-align: left;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--muted);
      }
      .forum-table tr:nth-child(even) td { background: var(--panel-soft); }

      .cat-name { font-size: 15px; font-weight: 700; color: var(--accent-strong); }
      .cat-desc { font-size: 12px; margin-top: 4px; color: var(--muted); }

      .thread-title { font-weight: 700; font-size: 14px; color: var(--accent-strong); }
      .thread-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
      .mono { font-family: "SFMono-Regular", "Consolas", monospace; font-size: 12px; color: #45516a; }

      .col-count { width: 90px; text-align: center; }
      .col-action { width: 120px; text-align: center; }
      .col-time { width: 210px; text-align: center; }
      .col-click { width: 100px; text-align: center; }
      .col-user { width: 140px; text-align: center; }

      .link-btn {
        display: inline-block;
        padding: 7px 10px;
        background: #f0f3fb;
        border: 1px solid var(--border);
        color: var(--accent-strong);
        text-decoration: none;
        font-weight: 700;
        font-size: 12px;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px #ffffffb0;
      }
      .link-btn:hover { background: #e5ebf7; }

      .bucket { margin-bottom: 14px; border: 1px solid var(--border); background: #ffffff; }
      .bucket-head {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(180deg, #f3f6ff, #e9eef7);
        border-bottom: 1px solid var(--border);
      }
      .bucket-name { font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; font-size: 12px; color: var(--muted); }

      .empty-row {
        padding: 12px;
        border: 1px dashed var(--border);
        background: var(--panel-soft);
        font-size: 13px;
        color: var(--muted);
      }

      .forum-form label { font-weight: 700; font-size: 13px; color: var(--ink); }
      .forum-form input[type="text"],
      .forum-form textarea,
      .forum-form select {
        width: 100%;
        max-width: 520px;
        padding: 8px;
        border: 1px solid var(--border);
        font-size: 13px;
        background: #fff;
        color: var(--ink);
        border-radius: 3px;
      }
      .forum-form textarea { resize: vertical; min-height: 110px; }
      .forum-form .form-row { margin-top: 12px; }
      .forum-form input[type="submit"] {
        margin-top: 6px;
        padding: 8px 14px;
        font-size: 13px;
        border: 1px solid var(--border);
        background: #f0f3fb;
        color: var(--accent-strong);
        cursor: pointer;
        border-radius: 3px;
        box-shadow: inset 0 0 0 1px #ffffffb0;
      }
      .forum-form input[type="submit"]:hover { background: #e5ebf7; }

      .form-actions { margin-bottom: 10px; }
      .hint { font-size: 11px; color: var(--muted); margin-left: 6px; }

      .tip-line { font-size: 12px; margin-top: 6px; color: var(--muted); }
    </style>

    <script>
      function toggleBox(listId, formId, btnId, mode) {
        var list = document.getElementById(listId);
        var form = document.getElementById(formId);
        var btn = document.getElementById(btnId);
        if (mode === "form") {
          if (list) list.style.display = "none";
          if (form) form.style.display = "block";
          if (btn) btn.style.display = "none";
        } else {
          if (form) form.style.display = "none";
          if (list) list.style.display = "block";
          if (btn) btn.style.display = "inline-block";
        }
      }

      function openForm(e, containerId, listId, formId, btnId) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var box = document.getElementById(containerId);
        if (box) box.classList.add("expanded");
        toggleBox(listId, formId, btnId, "form");
      }

      function launchEmbed() {
        var titleField = document.getElementById("thread-title");
        var expField = document.getElementById("thread-expiration");
        var linkField = document.getElementById("thread-stream-link");

        var titleVal = titleField ? titleField.value : "";
        var expVal = expField ? expField.value : "";
        var linkVal = linkField ? linkField.value : "";

        var catPath = "{{ current_path }}";
        var base = "/forum" + (catPath ? "/" + catPath : "");

        var retParams = new URLSearchParams();
        retParams.set("open_thread_form", "1");
        if (titleVal) retParams.set("prefill_title", titleVal);
        if (expVal) retParams.set("prefill_exp", expVal);
        if (linkVal) retParams.set("prefill_stream", linkVal);
        var returnTo = base + "?" + retParams.toString();

        var params = new URLSearchParams();
        params.set("return_to", returnTo);
        params.set("category_path", catPath);
        if (titleVal) params.set("prefill_title", titleVal);
        if (expVal) params.set("prefill_exp", expVal);
        if (linkVal) params.set("prefill_stream", linkVal);

        window.location.href = "/embed_stream?" + params.toString();
      }

      // auto-open add-thread form when redirected back from choose_stream
      function autoOpenThreadForm() {
        var canPost = "{{ '1' if allow_posting else '0' }}";
        var isAuthed = "{{ '1' if current_user else '0' }}";
        if (canPost !== "1") { return; }
        if (isAuthed !== "1") { return; }
        var shouldOpen = "{{ '1' if open_thread_form else '0' }}";
        if (shouldOpen === "1") {
          openForm(null, "threads-box", "thread-list", "thread-form", "add-thread-btn");
        }
      }

      window.addEventListener("DOMContentLoaded", autoOpenThreadForm);
    </script>
  </head>

  <body>
    <div class="page-wrap">
      <div class="page">
        <aside class="sidebar">
          <div class="panel search-panel">
            <h3>Search</h3>
            <form action="" method="GET">
              <input class="search-input" type="text" name="search" value="{{ search_query }}" placeholder="Search threads or categories">
              <div class="search-actions">
                <button class="search-btn" type="submit">Search</button>
                <a class="search-clear" href="{{ request.path }}">Clear</a>
              </div>
            </form>
            {% if search_query %}
              <div class="board-subtext" style="margin-top:10px;">Results for “{{ search_query }}”</div>
              <h4 style="margin:10px 0 6px 0;">Threads</h4>
              {% if search_results.threads|length == 0 %}
                <div class="empty-row">No thread matches.</div>
              {% else %}
                <table class="forum-table" style="font-size:12px;">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th class="col-click">Clicks</th>
                      <th class="col-action">Open</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for t in search_results.threads %}
                      <tr>
                        <td>
                          <div class="thread-title">{{ t.title }}</div>
                          <div class="search-meta"><a class="btn" href="{{ t.category_url }}">{{ t.category_name }}</a></div>
                        </td>
                        <td class="col-click">{{ t.clicks }}</td>
                        <td class="col-action"><a class="link-btn" href="{{ t.thread_url }}">Open</a></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% endif %}
              <h4 style="margin:12px 0 6px 0;">Categories</h4>
              {% if search_results.categories|length == 0 %}
                <div class="empty-row">No category matches.</div>
              {% else %}
                <table class="forum-table" style="font-size:12px;">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th class="col-count">Threads</th>
                      <th class="col-action">Open</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in search_results.categories %}
                      <tr>
                        <td>
                          <div class="cat-name">{{ c.name }}</div>
                          <div class="search-meta">{{ c.desc }}</div>
                        </td>
                        <td class="col-count">{{ c.threads }}</td>
                        <td class="col-action"><a class="link-btn" href="{{ c.url }}">Open</a></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% endif %}
            {% endif %}
          </div>
        </aside>

        <div class="main-wrap">
        <div class="forum-shell">
          <div class="forum-banner">
            <div>
              <h1>The Stream Den</h1>
              <p class="tagline">Share streams and links in a clean, classic forum layout.</p>
            </div>
            <div class="nav-actions">
              {% if current_path %}
                <a class="nav-btn" href="/forum{% if parent_path %}/{{ parent_path }}{% endif %}">← Back</a>
              {% endif %}
            </div>
          </div>

          <div class="crumbs">
            {% for crumb in breadcrumbs %}
              {% if not loop.first %}<span class="sep">&raquo;</span>{% endif %}
              <a href="{{ crumb.url }}">{{ crumb.name }}</a>
            {% endfor %}
          </div>

          {% if show_categories_section %}
            <section id="subcategories-box" class="board-card">
              <div class="board-head">
                <div>
                  <div class="board-title">{% if current_path %}Subcategories{% else %}Categories{% endif %}</div>
                  <div class="board-subtext">Pick a room to browse threads.</div>
                </div>
                <div class="board-actions">
                  <span class="chip">{{ categories|length }} total</span>
                </div>
              </div>

              <div id="subcat-list" class="board-body">
                {% if categories|length == 0 %}
                  <div class="empty-row">No rooms yet.</div>
                {% else %}
                  <table class="forum-table">
                    <thead>
                      <tr>
                        <th>{% if current_path %}Subcategory{% else %}Category{% endif %}</th>
                        <th class="col-count">Threads</th>
                        <th class="col-action">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for cat in categories %}
                      <tr>
                        <td>
                          <div class="cat-name">
                            <a class="btn" href="/forum{% if current_path %}/{{ current_path }}{% endif %}/{{ cat.slug }}">{{ cat.name }}</a>
                          </div>
                          <div class="cat-desc">{{ cat.desc }}</div>
                        </td>
                          <td class="col-count">{{ thread_counts.get(cat.id, 0) }}</td>
                          <td class="col-action">
                            <a class="link-btn" href="/forum{% if current_path %}/{{ current_path }}{% endif %}/{{ cat.slug }}">Enter »</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}
              </div>

            </section>
          {% endif %}

          <!-- Threads -->
          <section id="threads-box" class="board-card">
            <div class="board-head">
              <div>
                <div class="board-title">{{ thread_title }}</div>
                <div class="board-subtext">{{ thread_subtext }}</div>
              </div>

              <div class="board-actions">
                {% if allow_posting and current_user %}
                  <button id="add-thread-btn" class="ghost-btn" type="button"
                          onclick="openForm(event,'threads-box','thread-list','thread-form','add-thread-btn')">+ Post a stream</button>
                {% endif %}
              </div>
            </div>

            <div id="thread-list" class="board-body">
              {% if show_top_threads %}
                {% if threads_flat|length == 0 %}
                  <div class="empty-row">No streams yet.</div>
                {% else %}
                  <table class="forum-table thread-table">
                    <thead>
                    <tr>
                      <th>Stream Thread</th>
                      <th class="col-user">User</th>
                      <th class="col-time">Added (UTC)</th>
                      <th class="col-count">Replies</th>
                      <th class="col-click">Clicks</th>
                      <th class="col-action">Link</th>
                    </tr>
                    </thead>
                    <tbody>
                      {% for t in threads_flat %}
                        <tr>
                          <td>
                            <div class="thread-title">{{ t.title }}</div>
                            <div class="thread-meta">
                              {% set cat = cat_lookup.get(t.category_id) %}
                              {% if cat %}In {{ cat.name }}{% endif %}
                            </div>
                          </td>
                          <td class="col-user">{{ t.user or 'Anonymous' }}</td>
                          <td class="col-time"><span class="mono">{{ t.created_at }}</span></td>
                          <td class="col-count">{{ t.reply_count }}</td>
                          <td class="col-click">{{ t.clicks or 0 }}</td>
                          <td class="col-action">
                            <a class="link-btn" href="/thread/{{ t.id }}">Open</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}
              {% else %}
                {% for bucket in exp_choices %}
                  <div class="bucket">
                    <div class="bucket-head">
                      <div class="bucket-name">Expires: {{ bucket }}</div>
                      <span class="chip">{{ threads_grouped[bucket]|length }} listed</span>
                    </div>

                    {% if threads_grouped[bucket]|length == 0 %}
                      <div class="empty-row">No streams in this window.</div>
                    {% else %}
                      <table class="forum-table thread-table">
                        <thead>
                          <tr>
                            <th>Stream Thread</th>
                            <th class="col-user">User</th>
                            <th class="col-time">Added (UTC)</th>
                            <th class="col-count">Replies</th>
                            <th class="col-click">Clicks</th>
                            <th class="col-action">Link</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for t in threads_grouped[bucket] %}
                            <tr>
                              <td>
                                <div class="thread-title">{{ t.title }}</div>
                                <div class="thread-meta">
                                  Expires in {{ bucket }}
                                  {% if show_top_threads %}
                                    {% set cat = cat_lookup.get(t.category_id) %}
                                    {% if cat %}&mdash; in {{ cat.name }}{% endif %}
                                  {% endif %}
                                </div>
                              </td>
                              <td class="col-user">{{ t.user or 'Anonymous' }}</td>
                              <td class="col-time"><span class="mono">{{ t.created_at }}</span></td>
                              <td class="col-count">{{ t.reply_count }}</td>
                              <td class="col-click">{{ t.clicks or 0 }}</td>
                              <td class="col-action">
                                <a class="link-btn" href="/thread/{{ t.id }}">Open</a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% endif %}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            {% if allow_posting %}
              <div id="thread-form" class="board-body form-body" style="display:none;">
                <div class="form-actions">
                  <button class="ghost-btn" type="button"
                          onclick="toggleBox('thread-list','thread-form','add-thread-btn','list');">
                    « Back to threads
                  </button>
                </div>

                <form action="/add_thread" method="POST" class="forum-form">
                  <input type="hidden" name="category_path" value="{{ current_path }}">

                  <div class="form-row">
                    <label for="thread-title">Stream title</label><br>
                    <input type="text" id="thread-title" name="thread-title" maxlength="80" value="{{ prefill_title }}" required>
                  </div>

                  <div class="form-row">
                    <label for="thread-stream-link">Stream link</label>
                    <span class="hint">Prefer “embed stream” to auto-fill.</span><br>

                    <input type="text" id="thread-stream-link" name="thread-stream-link"
                           value="{{ prefill_stream }}" maxlength="500" required>

                    <div class="tip-line">
                      <button type="button" class="link-btn" onclick="launchEmbed();">Embed stream</button>
                    </div>
                  </div>

                  <div class="form-row">
                    <label for="thread-expiration">Expiration</label><br>
                    <select id="thread-expiration" name="thread-expiration" required>
                      {% for opt in exp_choices %}
                        <option value="{{ opt }}" {% if prefill_exp == opt %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-row">
                    <input type="submit" value="Post stream">
                  </div>
                </form>
              </div>
            {% endif %}
          </section>
        </div>
      </div>

        <div class="auth-panel panel search-panel">
          <h3>Account</h3>
          {% if current_user %}
            <div style="font-size:14px; margin-bottom:6px;">Logged in as <strong>{{ current_user }}</strong></div>
            <div class="search-actions" style="margin-top:6px;">
              <a class="search-btn" style="text-decoration:none;" href="/account">Account</a>
              <a class="search-clear" style="text-decoration:none;" href="/logout">Logout</a>
            </div>
          {% else %}
            <form action="/login" method="POST">
              <input type="hidden" name="next" value="{{ request.path }}">
              <label style="font-size:12px; color:var(--muted);">Username</label>
              <input class="search-input" type="text" name="username" required>
              <label style="font-size:12px; color:var(--muted);">Password</label>
              <input class="search-input" type="password" name="password" required>
              <div class="search-actions" style="margin-top:6px;">
                <button class="search-btn" type="submit">Login</button>
                <a class="search-clear" href="/signup">Sign up</a>
              </div>
            </form>
          {% endif %}
        </div>
      </div>
  </body>
</html>
