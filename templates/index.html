<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Stream Den</title>

    <style>
      :root {
        --ink: #d6e4ff;
        --ink-soft: #b6c7ec;
        --border: #1a2849;
        --panel: #0e172c;
        --stripe: #111c34;
        --accent: #2a4d94;
        --accent-dark: #193365;
        --link: #4aa3ff;
        --muted: #8a9bbd;
      }

      * { box-sizing: border-box; }

      body {
        font-family: "Verdana", "Geneva", sans-serif;
        color: var(--ink);
        background: #0a1120;
        padding: 26px;
        margin: 0;
      }

      a { color: var(--link); }
      a:visited { color: #8fb7ff; }

      .forum-shell {
        max-width: 1080px;
        margin: 0 auto;
        background: var(--panel);
        border: 2px solid #0b1427;
        box-shadow: 0 14px 36px rgba(5, 10, 20, 0.6);
      }

      .forum-banner {
        background: linear-gradient(180deg, #1c2c4f, #121b31);
        color: #f5f6fb;
        padding: 18px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        border-bottom: 2px solid #0b1427;
      }

      .eyebrow { text-transform: uppercase; font-size: 11px; letter-spacing: 0.15em; opacity: 0.8; }
      .forum-banner h1 { margin: 4px 0; font-size: 26px; }
      .tagline { margin: 0; font-size: 13px; opacity: 0.9; }

      .nav-actions { display: flex; gap: 10px; align-items: center; }
      .nav-btn {
        display: inline-block;
        padding: 8px 12px;
        font-size: 13px;
        border: 1px solid #21345e;
        color: #d6e4ff;
        text-decoration: none;
        background: linear-gradient(180deg, #1f2f51, #111a2d);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }
      .nav-btn:hover { background: linear-gradient(180deg, #2a3f6d, #152139); }

      .crumbs {
        padding: 12px 16px 10px 16px;
        font-size: 12px;
        border-bottom: 1px solid #10182d;
        background: linear-gradient(90deg, #0f192e, #111c34);
      }
      .crumbs a { text-decoration: none; font-weight: 600; color: #b7caf5; }
      .crumbs .sep { padding: 0 6px; color: var(--muted); }

      .board-card { border-top: 1px solid #0c1425; }
      .board-head {
        padding: 14px 16px;
        background: linear-gradient(180deg, #151f37, #0f182d);
        border-bottom: 1px solid #0c1425;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .board-title { font-size: 18px; font-weight: 700; color: #e9f0ff; }
      .board-subtext { margin-top: 4px; font-size: 12px; color: var(--muted); }
      .board-actions { display: flex; align-items: center; gap: 10px; }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        background: #1b2745;
        border: 1px solid #22345e;
        font-size: 12px;
        font-weight: 700;
        color: #d6e4ff;
      }
      .badge.muted { color: #7081a8; }

      .ghost-btn {
        font-family: inherit;
        font-size: 13px;
        padding: 7px 10px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, #162443, #0f192f);
        color: #d6e4ff;
        cursor: pointer;
        box-shadow: inset 0 0 0 1px #ffffff12;
      }
      .ghost-btn:hover { background: linear-gradient(180deg, #1e2f55, #131f38); }

      .board-body { padding: 14px 16px 18px 16px; background: #0f182d; }
      .form-body { background: #0c1529; border-top: 1px solid #0b1427; }

      .forum-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .forum-table th, .forum-table td {
        border: 1px solid #0f213f;
        padding: 10px;
        background: #101b31;
        color: #d6e4ff;
      }
      .forum-table th { background: #15233f; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
      .forum-table tr:nth-child(even) td { background: #0e172c; }

      .cat-name { font-size: 15px; font-weight: 700; }
      .cat-desc { font-size: 12px; margin-top: 4px; color: var(--muted); }

      .thread-title { font-weight: 700; font-size: 14px; color: #e7f0ff; }
      .thread-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
      .mono { font-family: "Courier New", monospace; font-size: 12px; color: #b8c6ec; }

      .col-count { width: 90px; text-align: center; }
      .col-action { width: 120px; text-align: center; }
      .col-time { width: 210px; text-align: center; }

      .link-btn {
        display: inline-block;
        padding: 6px 10px;
        background: #1c2e55;
        border: 1px solid #2e4c8a;
        color: #d6e4ff;
        text-decoration: none;
        font-weight: 700;
        font-size: 12px;
      }
      .link-btn:hover { background: #24406e; }

      .bucket { margin-bottom: 16px; border: 1px solid #0f213f; background: #0d1529; }
      .bucket-head {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(180deg, #122341, #0d1830);
        border-bottom: 1px solid #0f213f;
      }
      .bucket-name { font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; font-size: 12px; color: #d6e4ff; }

      .empty-row {
        padding: 12px;
        border: 1px dashed #1f335c;
        background: #0d1529;
        font-size: 13px;
        color: #8a9bbd;
      }

      .forum-form label { font-weight: 700; font-size: 13px; color: #d6e4ff; }
      .forum-form input[type="text"],
      .forum-form textarea,
      .forum-form select {
        width: 100%;
        max-width: 520px;
        padding: 8px;
        border: 1px solid #1f335c;
        font-size: 13px;
        background: #0a1120;
        color: #d6e4ff;
      }
      .forum-form textarea { resize: vertical; min-height: 110px; }
      .forum-form .form-row { margin-top: 12px; }
      .forum-form input[type="submit"] {
        margin-top: 6px;
        padding: 8px 14px;
        font-size: 13px;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, #1a2d53, #101a2f);
        color: #d6e4ff;
        cursor: pointer;
      }
      .forum-form input[type="submit"]:hover { background: linear-gradient(180deg, #223a6c, #152238); }

      .form-actions { margin-bottom: 10px; }
      .hint { font-size: 11px; color: var(--muted); margin-left: 6px; }

      .tip-line { font-size: 12px; margin-top: 6px; color: var(--muted); }
    </style>

    <script>
      function toggleBox(listId, formId, btnId, mode) {
        var list = document.getElementById(listId);
        var form = document.getElementById(formId);
        var btn = document.getElementById(btnId);
        if (mode === "form") {
          if (list) list.style.display = "none";
          if (form) form.style.display = "block";
          if (btn) btn.style.display = "none";
        } else {
          if (form) form.style.display = "none";
          if (list) list.style.display = "block";
          if (btn) btn.style.display = "inline-block";
        }
      }

      function openForm(e, containerId, listId, formId, btnId) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var box = document.getElementById(containerId);
        if (box) box.classList.add("expanded");
        toggleBox(listId, formId, btnId, "form");
      }

      // auto-open add-thread form when redirected back from choose_stream
      function autoOpenThreadForm() {
        var shouldOpen = "{{ '1' if open_thread_form else '0' }}";
        if (shouldOpen === "1") {
          openForm(null, "threads-box", "thread-list", "thread-form", "add-thread-btn");
        }
      }

      window.addEventListener("DOMContentLoaded", autoOpenThreadForm);
    </script>
  </head>

  <body>
    <div class="forum-shell">
      <div class="forum-banner">
        <div>
          <div class="eyebrow">Message Board</div>
          <h1>The Stream Den</h1>
          <p class="tagline">Share streams in an old-school forum layout.</p>
        </div>
        <div class="nav-actions">
          {% if parent_path %}
            <a class="nav-btn" href="/forum/{{ parent_path }}">← Back</a>
          {% else %}
            <a class="nav-btn" href="/forum">← Forum home</a>
          {% endif %}
        </div>
      </div>

      <div class="crumbs">
        {% for crumb in breadcrumbs %}
          {% if not loop.first %}<span class="sep">&raquo;</span>{% endif %}
          <a href="{{ crumb.url }}">{{ crumb.name }}</a>
        {% endfor %}
      </div>

      <!-- Subcategories -->
      <section id="subcategories-box" class="board-card">
        <div class="board-head">
          <div>
            <div class="board-title">Subcategories</div>
            <div class="board-subtext">Pick a room to browse threads.</div>
          </div>
          <div class="board-actions">
            <span class="badge">{{ categories|length }} total</span>
            <button id="add-cat-btn" class="ghost-btn" type="button"
                    onclick="openForm(event,'subcategories-box','subcat-list','subcat-form','add-cat-btn')">+ New category</button>
          </div>
        </div>

        <div id="subcat-list" class="board-body">
          {% if categories|length == 0 %}
            <div class="empty-row">No rooms yet. Start the first category.</div>
          {% else %}
            <table class="forum-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="col-count">Threads</th>
                  <th class="col-action">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in categories %}
                  <tr>
                    <td>
                      <div class="cat-name">{{ cat.name }}</div>
                      <div class="cat-desc">{{ cat.desc }}</div>
                    </td>
                    <td class="col-count">{{ cat.count }}</td>
                    <td class="col-action">
                      <a class="link-btn" href="/forum{% if current_path %}/{{ current_path }}{% endif %}/{{ cat.slug }}">Enter »</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>

        <div id="subcat-form" class="board-body form-body" style="display:none;">
          <div class="form-actions">
            <button class="ghost-btn" type="button"
                    onclick="toggleBox('subcat-list','subcat-form','add-cat-btn','list');">
              « Back to categories
            </button>
          </div>

          <form action="/add_category" method="POST" class="forum-form">
            <input type="hidden" name="parent_path" value="{{ current_path }}">

            <div class="form-row">
              <label for="category-name">Name</label><br>
              <input type="text" id="category-name" name="category-name" maxlength="12" required>
            </div>

            <div class="form-row">
              <label for="category-desc">Description</label><br>
              <textarea id="category-desc" name="category-desc" rows="4" required></textarea>
            </div>

            <div class="form-row">
              <input type="submit" value="Post category">
            </div>
          </form>
        </div>
      </section>

      <!-- Threads -->
      <section id="threads-box" class="board-card">
        <div class="board-head">
          <div>
            <div class="board-title">Streams &amp; Threads</div>
            <div class="board-subtext">Expiration buckets like a vintage forum lineup.</div>
          </div>

          <div class="board-actions">
            {% if current_path %}
              <button id="add-thread-btn" class="ghost-btn" type="button"
                      onclick="openForm(event,'threads-box','thread-list','thread-form','add-thread-btn')">+ Post a stream</button>
            {% else %}
              <span class="badge muted">Pick a category to post</span>
            {% endif %}
          </div>
        </div>

        <div id="thread-list" class="board-body">
          {% if not current_path %}
            <div class="empty-row">Choose a subcategory to see and post threads.</div>
          {% else %}
            {% for bucket in exp_choices %}
              <div class="bucket">
                <div class="bucket-head">
                  <div class="bucket-name">Expires: {{ bucket }}</div>
                  <span class="badge">{{ threads_grouped[bucket]|length }} listed</span>
                </div>

                {% if threads_grouped[bucket]|length == 0 %}
                  <div class="empty-row">No streams in this window.</div>
                {% else %}
                  <table class="forum-table thread-table">
                    <thead>
                      <tr>
                        <th>Stream Thread</th>
                        <th class="col-time">Added (UTC)</th>
                        <th class="col-count">Replies</th>
                        <th class="col-action">Link</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for t in threads_grouped[bucket] %}
                        <tr>
                          <td>
                            <div class="thread-title">{{ t.title }}</div>
                            <div class="thread-meta">Expires in {{ bucket }}</div>
                          </td>
                          <td class="col-time"><span class="mono">{{ t.created_at }}</span></td>
                          <td class="col-count">{{ t.reply_count }}</td>
                          <td class="col-action">
                            <a class="link-btn" href="/thread/{{ t.id }}">Open</a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <div id="thread-form" class="board-body form-body" style="display:none;">
          <div class="form-actions">
            <button class="ghost-btn" type="button"
                    onclick="toggleBox('thread-list','thread-form','add-thread-btn','list');">
              « Back to threads
            </button>
          </div>

          <form action="/add_thread" method="POST" class="forum-form">
            <input type="hidden" name="category_path" value="{{ current_path }}">

            <div class="form-row">
              <label for="thread-title">Stream title</label><br>
              <input type="text" id="thread-title" name="thread-title" maxlength="80" required>
            </div>

            <div class="form-row">
              <label for="thread-stream-link">Stream link</label>
              <span class="hint">Prefer “embed stream” to auto-fill.</span><br>

              <input type="text" id="thread-stream-link" name="thread-stream-link"
                     value="{{ prefill_stream }}" maxlength="500" required>

              <div class="tip-line">
                <a class="link-btn" href="/embed_stream?return_to=/forum/{{ current_path }}&category_path={{ current_path }}">Embed stream</a>
              </div>
            </div>

            <div class="form-row">
              <label for="thread-expiration">Expiration</label><br>
              <select id="thread-expiration" name="thread-expiration" required>
                {% for opt in exp_choices %}
                  <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-row">
              <input type="submit" value="Post stream">
            </div>
          </form>
        </div>
      </section>
    </div>
  </body>
</html>
